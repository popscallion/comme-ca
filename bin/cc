#!/usr/bin/env bash
# cc - The Pipe: CLI wrapper for comme-ca prompts
# Bridges terminal and Markdown prompts with Raycast compatibility

set -euo pipefail

# Configuration
PROMPTS_DIR="${COMME_CA_HOME:-$HOME/dev/comme-ca}/prompts/pipe"
ENGINE="${COMME_CA_ENGINE:-goose}"  # Default: goose; override: claude

# Usage
usage() {
    cat <<EOF
Usage: cc <prompt-name> [input]
       cc init
       cc update
       echo "input" | cc <prompt-name>

Examples:
  cc init                      # Initialize agent orchestration in current dir
  cc update                    # Pull comme-ca updates and diff AGENTS.md
  cc git "create branch foo"   # Translate to git command
  cc shell "list processes"    # Translate to shell command
  echo "SELECT * FROM users" | cc sql-check

Environment:
  COMME_CA_HOME   - Path to comme-ca repo (default: ~/dev/comme-ca)
  COMME_CA_ENGINE - AI engine: goose (default) or claude
EOF
    exit 1
}

# Init: Bootstrap agent orchestration in current directory
init() {
    # Check if files already exist
    if [[ -f "AGENTS.md" ]] || [[ -f "CLAUDE.md" ]]; then
        echo "Error: AGENTS.md or CLAUDE.md already exists in $(pwd)" >&2
        exit 1
    fi

    # Get source files from scaffolds
    local scaffold_dir="${COMME_CA_HOME:-$HOME/dev/comme-ca}/scaffolds/high-low"

    if [[ ! -d "$scaffold_dir" ]]; then
        echo "Error: Scaffold directory not found at ${scaffold_dir}" >&2
        echo "Ensure comme-ca is installed at ~/dev/comme-ca" >&2
        exit 1
    fi

    # Copy scaffold files
    cp "${scaffold_dir}/AGENTS.md" . || {
        echo "Error: Failed to copy AGENTS.md" >&2
        exit 1
    }

    cp "${scaffold_dir}/CLAUDE.md" . || {
        echo "Error: Failed to copy CLAUDE.md" >&2
        exit 1
    }

    echo "Initialized agent orchestration in $(pwd)."
}

# Update: Pull comme-ca changes and diff AGENTS.md
update() {
    local comme_ca_dir="${COMME_CA_HOME:-$HOME/dev/comme-ca}"

    # Check if AGENTS.md exists in current directory
    if [[ ! -f "AGENTS.md" ]]; then
        echo "Error: No AGENTS.md in current directory. Run 'cc init' first." >&2
        exit 1
    fi

    # Pull latest changes
    echo "Pulling latest comme-ca updates..."
    if ! (cd "$comme_ca_dir" && git pull --ff-only); then
        echo "Error: Failed to update comme-ca repository" >&2
        exit 1
    fi

    # Diff AGENTS.md
    local scaffold="${comme_ca_dir}/scaffolds/high-low/AGENTS.md"
    echo ""
    echo "Diff: local AGENTS.md vs comme-ca scaffold:"
    echo "─────────────────────────────────────────────"
    diff -u AGENTS.md "$scaffold" || true
    echo "─────────────────────────────────────────────"

    echo ""
    echo "To apply updates: cp '$scaffold' ./AGENTS.md"
}

# Main
main() {
    # Validate arguments
    if [[ $# -eq 0 ]]; then
        usage
    fi

    local prompt_name="$1"
    shift

    # Handle init subcommand
    if [[ "$prompt_name" == "init" ]]; then
        init
        exit 0
    fi

    # Handle update subcommand
    if [[ "$prompt_name" == "update" ]]; then
        update
        exit 0
    fi

    local prompt_file="${PROMPTS_DIR}/${prompt_name}.md"

    # Check if prompt exists
    if [[ ! -f "$prompt_file" ]]; then
        echo "Error: Prompt '${prompt_name}' not found at ${prompt_file}" >&2
        exit 1
    fi

    # Get user input (from args or stdin)
    local user_input=""
    if [[ $# -gt 0 ]]; then
        user_input="$*"
    elif [[ ! -t 0 ]]; then  # Check if stdin is available
        user_input=$(cat)
    else
        echo "Error: No input provided. Use argument or pipe stdin." >&2
        exit 1
    fi

    # Read the prompt template
    local prompt_template
    prompt_template=$(cat "$prompt_file")

    # Apply Raycast Shim: Replace placeholders
    local processed_prompt
    processed_prompt=$(apply_raycast_shim "$prompt_template" "$user_input")

    # Execute via configured engine
    execute_engine "$processed_prompt"
}

# Raycast Shim: Parse and replace placeholders
apply_raycast_shim() {
    local template="$1"
    local user_input="$2"

    # Get system context
    local shell_name
    shell_name=$(basename "$SHELL")
    local os_name
    os_name=$(uname -s)

    # Replace placeholders (order matters)
    # {argument name="..." default="..."}  → user input
    # {selection ...}                       → user input
    # {clipboard ...}                       → user input (future: pbpaste)
    # {shell_name}                          → active shell
    # {os_name}                             → OS name

    local result="$template"

    # Replace {argument ...} with user input
    result=$(echo "$result" | sed -E 's/\{argument[^}]*\}/'"$(escape_sed "$user_input")"'/g')

    # Replace {selection ...} with user input
    result=$(echo "$result" | sed -E 's/\{selection[^}]*\}/'"$(escape_sed "$user_input")"'/g')

    # Replace {clipboard ...} with user input (for now; could use pbpaste/xclip)
    result=$(echo "$result" | sed -E 's/\{clipboard[^}]*\}/'"$(escape_sed "$user_input")"'/g')

    # Replace {shell_name} with actual shell
    result=$(echo "$result" | sed 's/{shell_name}/'"$shell_name"'/g')

    # Replace {os_name} with OS
    result=$(echo "$result" | sed 's/{os_name}/'"$os_name"'/g')

    echo "$result"
}

# Escape special characters for sed replacement
escape_sed() {
    echo "$1" | sed 's/[&/\]/\\&/g'
}

# Execute processed prompt via AI engine
execute_engine() {
    local prompt="$1"

    case "$ENGINE" in
        goose)
            # Goose: Use run mode with text flag
            goose run -t "$prompt"
            ;;
        claude)
            # Claude Code: Headless mode
            echo "$prompt" | claude
            ;;
        *)
            echo "Error: Unknown engine '$ENGINE'. Use 'goose' or 'claude'." >&2
            exit 1
            ;;
    esac
}

# Entry point
main "$@"
