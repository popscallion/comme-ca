#!/usr/bin/env bash
# comme-ca installer: Bootstrap the intelligence system

set -euo pipefail

INSTALL_DIR="$HOME/dev/comme-ca"
REPO_URL="git@github.com:popscallion/comme-ca"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Print colored messages
info() {
    echo -e "${GREEN}▸${NC} $1"
}

warn() {
    echo -e "${YELLOW}⚠${NC} $1"
}

error() {
    echo -e "${RED}✗${NC} $1" >&2
}

# Check if repository already exists
check_repo() {
    if [[ -d "$INSTALL_DIR" ]]; then
        return 0
    fi
    return 1
}

# Clone the repository
clone_repo() {
    echo
    read -p "Clone comme-ca to ~/dev/comme-ca? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        error "Installation cancelled."
        exit 1
    fi

    info "Cloning comme-ca..."
    mkdir -p "$(dirname "$INSTALL_DIR")"

    if ! git clone "$REPO_URL" "$INSTALL_DIR"; then
        error "Failed to clone repository. Ensure you have git installed and SSH access to GitHub."
        exit 1
    fi

    info "Repository cloned to $INSTALL_DIR"
}

# Detect user's shell
detect_shell() {
    local shell_name
    shell_name=$(basename "$SHELL")

    case "$shell_name" in
        fish)
            echo "fish"
            ;;
        zsh)
            echo "zsh"
            ;;
        bash)
            echo "bash"
            ;;
        *)
            warn "Unknown shell: $shell_name (defaulting to bash)"
            echo "bash"
            ;;
    esac
}

# Get config file path for shell
get_config_file() {
    local shell_type="$1"

    case "$shell_type" in
        fish)
            echo "$HOME/.config/fish/config.fish"
            ;;
        zsh)
            echo "$HOME/.zshrc"
            ;;
        bash)
            # Prefer .bashrc if it exists, otherwise .bash_profile
            if [[ -f "$HOME/.bashrc" ]]; then
                echo "$HOME/.bashrc"
            else
                echo "$HOME/.bash_profile"
            fi
            ;;
    esac
}

# Check if config already has comme-ca setup
has_config() {
    local config_file="$1"

    if [[ ! -f "$config_file" ]]; then
        return 1
    fi

    grep -q "comme-ca" "$config_file" && grep -q "prep" "$config_file"
}

# Add configuration for Fish
add_fish_config() {
    local config_file="$1"

    mkdir -p "$(dirname "$config_file")"

    cat >> "$config_file" <<'EOF'

# comme-ca intelligence system
set -gx PATH $HOME/dev/comme-ca/bin $PATH
EOF
}

# Add configuration for Bash/Zsh
add_posix_config() {
    local config_file="$1"

    cat >> "$config_file" <<'EOF'

# comme-ca intelligence system
export PATH="$HOME/dev/comme-ca/bin:$PATH"
EOF
}

# Configure shell
configure_shell() {
    local shell_type
    shell_type=$(detect_shell)

    local config_file
    config_file=$(get_config_file "$shell_type")

    info "Detected shell: $shell_type"
    info "Config file: $config_file"

    if has_config "$config_file"; then
        warn "comme-ca configuration already exists in $config_file"
        return 0
    fi

    info "Adding comme-ca configuration to $config_file..."

    case "$shell_type" in
        fish)
            add_fish_config "$config_file"
            ;;
        *)
            add_posix_config "$config_file"
            ;;
    esac

    info "Configuration added to $config_file"
}

# Main installation flow
main() {
    echo
    info "comme-ca installer"
    echo

    # Step 1: Check/clone repository
    if check_repo; then
        info "Repository already exists at $INSTALL_DIR"
    else
        clone_repo
    fi

    # Step 2: Configure shell
    configure_shell

    # Step 3: Tool Setup
    info "Configuring AI Tools..."
    export COMME_CA_HOME="$INSTALL_DIR"
    "$INSTALL_DIR/bin/cca" setup:claude || warn "Claude setup had minor issues."
    "$INSTALL_DIR/bin/cca" setup:gemini || warn "Gemini setup had minor issues."

    # Step 4: Verify installation
    echo
    info "Installation complete!"
    echo
    info "Next steps:"
    echo "  1. Restart your shell or run: source $(get_config_file "$(detect_shell)")"
    echo "  2. Verify with: which cca"
    echo "  3. Initialize a project: cd <project> && cca init"
    echo "  4. Use agents (in Claude/Gemini): /prep, /plan, /audit"
    echo "  5. Use pipe: cca git \"create branch foo\""
    echo
}

main "$@"